#!/bin/sh

# Configure installation of shared grading scripts

PREFIX=$HOME
SOURCE_DIR=`dirname $0`
PERLDIR=
LIBDIR=
MANDIR=
CONFIG="$0 $*"

while [ $# -gt 0 ]; do

    case "$1" in
	--prefix=*)	
	    PREFIX="`echo X$1 | sed 's/^X--prefix=//'`";
	    shift;;
	--sharebindir=*)
	    SHAREBINDIR="`echo X$1 | sed 's/^X--sharebindir=//'`";
	    shift;;
	--suiddir=*)
	    SUIDDIR="`echo X$1 | sed 's/^X--suiddir=//'`";
	    shift;;
	--libdir=*)
	    LIBDIR="`echo X$1 | sed 's/^X--libdir=//'`";
	    shift;;
	--mandir=*)
	    MANDIR="`echo X$1 | sed 's/^X--mandir=//'`";
	    shift;;
	--docdir=*)
	    DOCDIR="`echo X$1 | sed 's/^X--docdir=//'`";
	    shift;;
	--prcs=*)
	    PRCS_PROG="`echo X$1 | sed 's/^X--prcs=//'`";
	    shift;;
	--svndir=*)
	    SVN_EXEC_DIR="`echo X$1 | sed 's/^X--svndir=//'`";
	    shift;;
	*)
	    echo "Usage: .../configure \\"
            echo "   [ --prefix=PREFIX ] [ --sharebindir=SDIR ] \\"
	    echo "   [ --suiddir=SUIDIR ] [ --libdir=LDIR ] \\"
	    echo "   [ --mandir=MDIR ] [ --docdir=DDIR ] \\"
	    echo "   [ --prcs=PRCS_PROG ]"
	    echo "   [ --svndir=SVN_EXEC_DIR ]"
	    exit 1;;
    esac

done

findDir () {
    prog=$1
    path="`echo $PATH | sed -e 's/:/ /g'`"
    for d in $path; do
	if [ -f $d/$prog -a -x $d/$prog ]; then
	    echo $d
	    return 0
        fi
    done
    return 1
}


if [ -z "$PRCS_PROG" ]; then
    if dir=`findDir prcs`; then
	PRCS_PROG="$dir/prcs"
	echo "prcs is $PRCS_PROG"
    fi
fi	    
if [ ! -x "$PRCS_PROG" ]; then
    echo "configure: Could not find prcs."
    exit 1
fi

if [ -z "$SVN_EXEC_DIR" ]; then
    if dir=`findDir svn`; then
	SVN_EXEC_DIR="$dir"
	echo "svn is in $SVN_EXEC_DIR"
    fi
fi	    
if [ ! -d "$SVN_EXEC_DIR" ]; then
    echo "configure: Could not find svn."
    exit 1
fi

for subdir in . run-as-class-master; do

    if [ ! -d $subdir ]; then mkdir $subdir; fi
    if expr "X${SOURCE_DIR}" : "X/" > /dev/null; then 
        SOURCE_DIR_VAL=${SOURCE_DIR};
    else
        SOURCE_DIR_VAL=`pwd`/${SOURCE_DIR};
    fi

    echo "Creating $subdir/Makefile from ${SOURCE_DIR}/Makefile.in"

    rm -f $subdir/Makefile
    echo "# Created from ${SOURCE_DIR}/$subdir/Makefile.in on `date`." \
	    >$subdir/Makefile
    sed -e "s,@PREFIX@,$PREFIX,g" \
	-e "s,@SHAREBINDIR@,${SHAREBINDIR:-$PREFIX/share/bin},g" \
	-e "s,@SUIDDIR@,${SUIDDIR:-$PREFIX/share/bin/suid},g" \
	-e "s,@LIBDIR@,${LIBDIR:-$PREFIX/share/lib},g" \
	-e "s,@MANDIR@,${MANDIR:-$PREFIX/share/man},g" \
	-e "s,@DOCDIR@,${DOCDIR:-$PREFIX/share/doc},g" \
	-e "s,@PRCS_PROG@,${PRCS_PROG},g" \
	-e "s,@SVN_EXEC_DIR@,${SVN_EXEC_DIR},g" \
	-e "s,@SOURCE_DIR@,${SOURCE_DIR_VAL},g" \
	-e "s,%%,@,g" \
       ${SOURCE_DIR}/$subdir/Makefile.in >> $subdir/Makefile

done

rm -f config.status
echo "# Configuration command:" > config.status
echo "$CONFIG" >> config.status

echo "Configuration complete.  Use GNU make to install:"
echo "   'make install' installs software in configured location."
echo "For each class master, you must build and install a 'run-as-...'"
echo "suid program.  See run-as-class-master/README for details."

exit 0
