#!/usr/bin/env perl
# -*- mode: Perl;-*-
# Version @VERSION@
# See the file COPYING in the main distribution directory for copyright notice.

use Net::Domain qw(hostname hostfqdn);
unshift (@INC, '@LIBDIR@');
require "GradingBase.pl";
CmndLine ("", 2, 2);
require "GradingCommon.pl";

$svnlook = '@SVN_EXEC_DIR@/svnlook';
$repos = shift;
$rev = shift;

@changes = `$svnlook changed -r $rev $repos`;
$time = `$svnlook date -r $rev $repos`;

foreach (@changes) {
    if (($type, $path) = /^(.).\s+(.*)\s*$/) {
	if (($dir) = ($path =~ /$SVN_SUBMISSION_PATN/)) {
	    ($who) = ($path =~ /$SVN_SUBMITTER_PATN/);
	    ($assgn) = ($path =~ /$SVN_ASSGN_PATN/);
	    if ((StudentExists ($who) or TeamExists ($who)) 
		and AssignmentExists ($assgn)) {
		$key = "$assgn/$who";
		if ($path eq "$dir/" and $type eq 'D') {
		    $deletions{$key} = 1;
		    $submitted{$key} = 0;
		} elsif (not $deletions{key}) {
		    $submitted{$key} = $dir;
		    $assgns{$assgn} = 1;
		}
	    }
	}
    }
}

if (%submitted) {
    if ($time =~ /^(\d\d\d\d-\d\d-\d\d \d\d:\d\d:\d\d) ([-+]\d\d)/) {
	$localtimestr = $1;
	$adjust = $2;
	$localtimestr =~ s/[-: ]//g;
	$timestamp = TimeToTimeStamp (TimeStampToTime ($localtimestr) - $adjust * 3600);
    } else {
	$timestamp = TimeToTimeStamp (time);
    }

    umask (0007);

    foreach $assgn (keys %assgns) {
	if (! (-d "$SUBMISSION_DIR/$assgn" && -w "$SUBMISSION_DIR/$assgn")) {
	    InitDir ("$SUBMISSION_DIR/$assgn", 0777, $CLASSROOT);
	}
    }

    foreach $key (keys %submitted) {
	next if not $submitted{$key};
	$subm = "$SUBMISSION_DIR/$key.$timestamp";
	open (SUBMIT, ">", $subm) || next;
	print SUBMIT "SVN submission\n";
	print SUBMIT "$submitted{$key}\n";
	print SUBMIT "$rev\n";
	close SUBMIT || next;
	($assgn, $who) = ($key =~ m{(.*)/(.*)});
	next if not TeamExists ($who);
	$base = "$who.$timestamp";
	foreach $login (split (/\s+/, TeamMembers ($who))) {
	    symlink ($base, "$SUBMISSION_DIR/$assgn/$login.$timestamp");
	}
    }
}

exit 0;

